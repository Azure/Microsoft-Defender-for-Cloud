{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "ComputeSecurityDashboardv4",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "azure monitor",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"45d227d9-af00-4423-a2aa-ddb57c99cece\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SubscriptionName\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"typeSettings\":{\"additionalResourceOptions\":[],\"includeAll\":true,\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"value\":[\"/subscriptions/d0d4dfbc-9f34-41b1-8767-58818e4ac738\"]},{\"id\":\"b3160ddb-f03a-4f9b-a551-e8cd22bc232f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Info\",\"type\":10,\"isRequired\":true,\"value\":\"Off\",\"typeSettings\":{\"additionalResourceOptions\":[]},\"jsonData\":\"[\\r\\n { \\\"value\\\": \\\"Off\\\", \\\"label\\\": \\\"Off\\\"},\\r\\n { \\\"value\\\": \\\"FAQ\\\", \\\"label\\\": \\\"FAQ\\\"},\\r\\n { \\\"value\\\": \\\"Change Log\\\", \\\"label\\\": \\\"Change Log\\\"}\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 0\"},{\"type\":1,\"content\":{\"json\":\"### Change Log \\r\\n\\r\\n|Version|Description|\\r\\n|---|---|\\r\\n|v0.1| Private preview of the initial version| \",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Info\",\"comparison\":\"isEqualTo\",\"value\":\"Change Log\"},\"name\":\"ChangeLog\"},{\"type\":1,\"content\":{\"json\":\"### FAQ\\r\\n\\r\\nCompute Security Dashboard workbook. This workbook will be useful for security and operations team to have an aggregated view across your all virtual machine resources including security recommendations!\\r\\n\\r\\n#### Q: What is the data source for this workbook?\\r\\n* **Answer**: This workbook utlizes Azure Resource Graph (ARG) queries to show real-time virtual machine resources and thier configuration.\\r\\n\\r\\n#### Q: Can I edit or update the queries in the workbook?\\r\\n* **Answer**: Yes, you can customize this workbook and its queries by clicking on the editing the workbook and then clicking on the Edit button for a specific query you want to update.\\r\\n\\r\\n#### Q: How do I get future versions of this workbook?\\r\\n* **Answer**:  This workbook is available on the ASC community repository (GitHub), any new versions will be available at [this](https://github.com/Azure/Azure-Security-Center/tree/main/Workbooks) location and you will be able to re-deploy a new version anytime you want.\\r\\n\\r\\n#### Q: How do I get support?\\r\\n* **Answer**: All artifacts within the ASC community repository are provided as is, without SLA or official support. However, if you have an issue please fill out a [bug report](https://github.com/Azure/Azure-Security-Center/issues/new?assignees=&labels=&template=bug_report.md&title=Network security workbook) and the community will try to solve it.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Info\",\"comparison\":\"isEqualTo\",\"value\":\"FAQ\"},\"name\":\"FAQ\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"0b98a623-1697-45bd-87d3-9caf7c264e74\",\"cellValue\":\"vmtab\",\"linkTarget\":\"parameter\",\"linkLabel\":\" Virtual Machine inventory\",\"subTarget\":\"vmlist\",\"preText\":\"Orphaned Assets\",\"style\":\"link\"},{\"id\":\"9f098434-47b4-4d8e-8163-799ff94e6a7b\",\"cellValue\":\"vmtab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Orphaned  Assets\",\"subTarget\":\"orphanedasset\",\"style\":\"link\"},{\"id\":\"1bac5252-8da9-447a-adb3-6d58adb599c7\",\"cellValue\":\"vmtab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Virtual Machine Status\",\"subTarget\":\"vmstatus\",\"style\":\"link\"},{\"id\":\"8fd42c76-d68a-4219-831b-1b17d2da580b\",\"cellValue\":\"vmtab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Security Recommendations\",\"subTarget\":\"vmrecom\",\"style\":\"link\"},{\"id\":\"7ea21b5b-9480-478d-9b14-29075505c205\",\"cellValue\":\"vmtab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Service Principal\",\"subTarget\":\"account\",\"style\":\"link\"},{\"id\":\"7721f2c1-debd-44a9-b82f-c1924ed3ab64\",\"cellValue\":\"vmtab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Backup\",\"subTarget\":\"backup\",\"style\":\"link\"},{\"id\":\"9cffe411-7d12-4340-a92d-b75fb2e17dac\",\"cellValue\":\"vmtab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Encryption\",\"subTarget\":\"encrypt\",\"style\":\"link\"},{\"id\":\"a59d1200-b79e-431e-8be6-8ad97005efb4\",\"cellValue\":\"vmtab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Recource Changes\",\"subTarget\":\"change\",\"style\":\"link\"},{\"id\":\"1fe9d56d-46b3-4459-b86b-020396ad09d2\",\"cellValue\":\"vmtab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Subscription RBAC\",\"subTarget\":\"rbac\",\"style\":\"link\"}]},\"name\":\"MainMenu\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ 'Microsoft.Compute/virtualMachines' \\r\\n| where isnull(properties.storageProfile.osDisk.managedDisk)\",\"size\":0,\"showAnalytics\":true,\"title\":\"List of Azure VMs not having Managed Disks \",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"encrypt\"},\"name\":\"VmnothavingManageddisks\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"GuestConfigurationResources\\r\\n| where name in ('WindowsPendingReboot')\\r\\n| project id, name, resources = properties.latestAssignmentReport.resources, vmid = split(properties.targetResourceId,'/'), status = tostring(properties.complianceStatus)\\r\\n| extend resources = iff(isnull(resources[0]), dynamic([{}]), resources)\\r\\n| mvexpand resources\\r\\n| extend reasons = resources.reasons\\r\\n| extend reasons = iff(isnull(reasons[0]), dynamic([{}]), reasons)\\r\\n| mvexpand reasons\\r\\n| project id, vmid, name, status, resource = resources.resourceId, reason = reasons.phrase\\r\\n| summarize name = any(name), status = any(status), vmid = any(vmid), resources = make_list_if(resource, isnotnull(resource)), reasons = make_list_if(reason, isnotnull(reason)) by id = tolower(id)\\r\\n| project id, machine = tostring(vmid[(-1)]), type = tostring(vmid[(-3)]), name, status, reasons\",\"size\":0,\"showAnalytics\":true,\"title\":\"List of Azure VMs with pending reboot status\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"vmstatus\"},\"name\":\"VMpendingreboot\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Resources\\r\\n| where type =~ 'Microsoft.Compute/virtualMachines'\\r\\n| where properties.extended.instanceView.powerState.code != 'PowerState/running'\\r\\n| project vmName = name, powerstate = strcat(split(properties.extended.instanceView.powerState.code, '/')[1])\\r\\n| join kind = leftouter (GuestConfigurationResources\\r\\n\\t| extend vmName = tostring(split(properties.targetResourceId,'/')[(-1)])\\r\\n\\t| project vmName, name, compliance = properties.complianceStatus) on vmName | project-away vmName1\",\"size\":0,\"showAnalytics\":true,\"title\":\"List of Azure VMs shut down with their compliance state\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"vmstatus\"},\"name\":\"Azure VMs shut down\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Resources \\r\\n| where type == 'microsoft.compute/virtualmachines' \\r\\n| extend JoinID = toupper(id), VMName = tostring(properties.osProfile.computerName), OSType = tostring(properties.storageProfile.osDisk.osType), VMSize = tostring(properties.hardwareProfile.vmSize)\\r\\n| join kind=leftouter( Resources \\r\\n| where type == 'microsoft.compute/virtualmachines/extensions' \\r\\n| extend VMId = toupper(substring(id, 0, indexof(id, '/extensions'))), ExtensionName = name ) on $left.JoinID == $right.VMId \\r\\n| summarize Extensions = make_list(ExtensionName) by id, VMName, OSType, VMSize \\r\\n| order by tolower(VMName) asc\",\"size\":0,\"showAnalytics\":true,\"title\":\"List of extensions in Azure VMs\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"vmstatus\"},\"name\":\"Listofextensions\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Resources \\r\\n| where type =~'Microsoft.HybridCompute/machines' \\r\\n| extend JoinID = toupper(id), VMName = tostring(properties.osProfile.computerName), OSType = tostring(properties.osName)\\r\\n| join kind=leftouter( Resources \\r\\n| where type =~ 'Microsoft.HybridCompute/machines/extensions' \\r\\n| extend VMId = toupper(substring(id, 0, indexof(id, '/extensions'))), ExtensionName = name ) on $left.JoinID == $right.VMId \\r\\n| summarize Extensions = make_list(ExtensionName) by id, VMName, OSType\\r\\n| order by tolower(VMName) asc\",\"size\":0,\"showAnalytics\":true,\"title\":\"List of extensions in Azure Arc Servers\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"VMName\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"16ch\"}}]}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"vmstatus\"},\"name\":\"ListofArcextensions \",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"securityresources\\r\\n| where type =~ \\\"microsoft.security/assessments\\\"\\r\\n| where properties.status.code == \\\"Unhealthy\\\"\\r\\n| extend ResourceId = tolower(tostring(properties.resourceDetails.Id))\\r\\n| project DisplayName = tostring(properties.displayName),\\r\\nResourceId = tolower(properties.resourceDetails.Id),\\r\\nname,\\r\\nSeverity = tostring(properties.metadata.severity),\\r\\nSeverityRank = case(\\r\\n    properties.metadata.severity == 'High', 3,\\r\\n    properties.metadata.severity == 'Medium', 2,\\r\\n    properties.metadata.severity == 'Low', 1,\\r\\n    0\\r\\n    ),\\r\\nResourceType = tostring(split(id, \\\"/\\\")[6])\\r\\n| join kind=inner (securityresources\\r\\n| where type == 'microsoft.security/securescores/securescorecontrols'\\r\\n| extend AssessmentDefinitions = parse_json(properties.definition.properties.assessmentDefinitions)\\r\\n| mvexpand AssessmentDefinitions\\r\\n| extend name = tostring(split(AssessmentDefinitions.id, \\\"/\\\")[4])) on name\\r\\n| where ResourceType in~ ('microsoft.compute', 'Microsoft.HybridCompute', 'Microsoft.Sql')\\r\\n| summarize ResourceCount = count() by DisplayName, name, ControlName = tostring(properties.displayName), SeverityRank, Severity, ResourceType\\r\\n| sort by SeverityRank, ResourceCount desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Secure score recommendations for compute resources\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DisplayName\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"bladeOpenContext\":{\"bladeName\":\"RecommendationsBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"assessmentKey\",\"source\":\"column\",\"value\":\"name\"}]},\"customColumnWidthSetting\":\"80ch\"}},{\"columnMatch\":\"name\",\"formatter\":5},{\"columnMatch\":\"SeverityRank\",\"formatter\":5},{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"1\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"ResourceCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"red\"}}],\"labelSettings\":[{\"columnId\":\"DisplayName\",\"label\":\"Recommendation name\"},{\"columnId\":\"ControlName\",\"label\":\"Control name\"},{\"columnId\":\"ResourceCount\",\"label\":\"Resource count\"}]}},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"vmrecom\"},\"name\":\"Securescorerecommendations\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Resources\\r\\n| where type =~ 'Microsoft.Compute/virtualMachines' \\r\\n| extend OS= tostring(properties.storageProfile.osDisk.osType)\\r\\n| project name, OS, location, resourceGroup, powerstate = strcat(split(properties.extended.instanceView.powerState.code, '/')[1]), VMSize=properties.hardwareProfile.vmSize, SKU=properties.storageProfile.imageReference.sku\\r\\n| order by name desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"List of Azure Virtual Machines\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"],\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"vmlist\"},\"name\":\"VMinventory\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Resources\\r\\n| where type =~ \\\"Microsoft.HybridCompute/machines\\\"\\r\\n| extend OS= tostring(properties.osName)\\r\\n| project name, location, resourceGroup, Status=properties.status, OS, OSVersion= properties.osVersion\\r\\n| order by name desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"List of Azure Arc Servers\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"],\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"vmlist\"},\"name\":\"Arcinventory \",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.azurearcdata/sqlserverinstances\\\"\\r\\n| project InstanceId = id, InstanceName = name, Version = tostring(properties.version)\\r\\n| join kind = inner (\\r\\nresources\\r\\n| where type == \\\"microsoft.azurearcdata/sqlserverinstances/databases\\\"\\r\\n| where name !in (\\\"master\\\", \\\"model\\\", \\\"msdb\\\", \\\"tempdb\\\")\\r\\n| project InstanceId = substring(id, 0, indexof(id, \\\"Databases\\\", 0) - 1), DatabaseName = name, CompatibilityLevel = tostring(properties.compatibilityLevel)\\r\\n) on InstanceId\\r\\n| project InstanceName, DatabaseName, CompatibilityLevel = strcat(Version, \\\" - Level \\\", CompatibilityLevel)\\r\\n// | summarize Databases = count() by CompatibilityLevel\\r\\n| order by CompatibilityLevel asc\",\"size\":0,\"showAnalytics\":true,\"title\":\"List of Azure Arc SQL Servers and databases\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"],\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"vmlist\"},\"name\":\"ArcSqlinventory  \",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Resources\\r\\n| where type =~ \\\"microsoft.kubernetes/connectedclusters\\\"\\r\\n| project id, name, location, resourceGroup, Status=properties.connectivityStatus, Environment=properties.infrastructure, NodeCount= properties.totalNodeCount\\r\\n| order by name desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"List of Azure Arc Kubernetes Clusters\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"],\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"vmlist\"},\"name\":\"ArcKubernetesinventory \",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Resources\\r\\n| where type =~ 'Microsoft.Compute/virtualMachines'\\r\\n| summarize resourcecount=count() by location\\r\\n| order by resourcecount desc \\r\\n//| extend OS= tostring(properties.storageProfile.osDisk.osType)\\r\\n//| project name, OS, location, resourceGroup\\r\\n\",\"size\":0,\"title\":\"VM Location\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"],\"visualization\":\"map\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"resourcecount\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"resourcecount\",\"sortOrder\":1}],\"mapSettings\":{\"locInfo\":\"AzureLoc\",\"locInfoColumn\":\"location\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"location\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":null}},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"vmlist\"},\"name\":\"VMlocationmap\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources    \\r\\n| where type has \\\"microsoft.compute/disks\\\"   \\r\\n| extend diskState = tostring(properties.diskState)  \\r\\n| where managedBy == \\\"\\\" and diskState != 'ActiveSAS'  \\r\\nor diskState == 'Unattached' and diskState != 'ActiveSAS'   \\r\\n| project id, diskState, resourceGroup, location, subscriptionId\",\"size\":0,\"showAnalytics\":true,\"title\":\"Orphaned Disks\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"orphanedasset\"},\"name\":\"OrphanedDisks\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources  \\r\\n| where type =~ \\\"microsoft.network/networkinterfaces\\\"  \\r\\n| join kind=leftouter (resources  \\r\\n| where type =~ 'microsoft.network/privateendpoints'  \\r\\n| extend nic = todynamic(properties.networkInterfaces)  \\r\\n| mv-expand nic  \\r\\n| project id=tostring(nic.id) ) on id  \\r\\n| where isempty(id1)  \\r\\n| where properties !has 'virtualmachine'    \\r\\n| project id, resourceGroup, location, subscriptionId \",\"size\":0,\"showAnalytics\":true,\"title\":\"Orphaned Network Interface Cards\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"orphanedasset\"},\"name\":\"OrphanedNIC\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources  \\r\\n| where type =~ 'microsoft.compute/availabilitysets'  \\r\\n| extend VirtualMachines = array_length(properties.virtualMachines)  \\r\\n| where VirtualMachines == 0  \",\"size\":0,\"showAnalytics\":true,\"title\":\"Orphaned Availability Sets\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"orphanedasset\"},\"name\":\"OrphanedAvailailitySets\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources  \\r\\n| where type =~ 'microsoft.network/publicipaddresses'  \\r\\n| extend IpConfig = properties.ipConfiguration.id  \\r\\n| extend NATGW = properties.natGateway.id  \\r\\n| where isempty(IpConfig)\\r\\n| where isempty(NATGW)\",\"size\":0,\"showAnalytics\":true,\"title\":\"Orphaned Public IPs\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"orphanedasset\"},\"name\":\"OrphanedPublicIP\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Resources  \\r\\n| where type =~ 'microsoft.network/networksecuritygroups' and isnull(properties.networkInterfaces) and isnull(properties.subnets)  \\r\\n| project Resource=id, resourceGroup, subscriptionId, location  \",\"size\":0,\"showAnalytics\":true,\"title\":\"Orphaned Network Security Groups\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"orphanedasset\"},\"name\":\"OrphanedNSG\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.network/routetables\\\"\\r\\n| where isnull(properties.subnets)\\r\\n| extend Details = pack_all()\\r\\n| project subscriptionId, Resource=id, resourceGroup, location\",\"size\":0,\"showAnalytics\":true,\"title\":\"Orphaned Route Tables\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"orphanedasset\"},\"name\":\"Orphanedroutetables\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Resources\\r\\n| where type == \\\"microsoft.network/loadbalancers\\\"\\r\\n| where properties.backendAddressPools == \\\"[]\\\"\\r\\n| extend Details = pack_all()\\r\\n| project subscriptionId, Resource=id, resourceGroup, location\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Orphaned Load Balancers\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"orphanedasset\"},\"name\":\"OrphanedLoadbalancers\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ \\\"microsoft.web/serverfarms\\\"\\r\\n| where properties.numberOfSites == 0\\r\\n| extend Details = pack_all()\\r\\n| project Resource=id, resourceGroup, location, subscriptionId, Sku=sku.name, Tier=sku.tier, tags ,Details\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Orphaned App Service Plans\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"orphanedasset\"},\"name\":\"OrphanedAppserviceplans\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"securityresources\\r\\n| where type == \\\"microsoft.security/assessments/subassessments\\\"\\r\\n| extend assessmentKey = extract(\\\".*assessments/(.+?)/.*\\\",1,  id)\\r\\n| where assessmentKey == \\\"1195afff-c881-495e-9bc5-1486211ae03f\\\" and properties.status.code == 'Unhealthy'\\r\\n| project Resource = iif(isempty(properties.resourceDetails.id),strcat(split(properties.resourceDetails.workspaceId, '/')[8]), properties.resourceDetails.id), subscriptionId, severity = tostring(parse_json(properties).status.severity), status = tostring(parse_json(properties).status.code), description = tostring(parse_json(properties).displayName), VulnId = tostring(parse_json(properties).id), resourceGroup = substring(id, 0, indexof(id, '/providers'))\\r\\n| summarize dcount(VulnId) by Resource, severity, VulnId, description\\r\\n| summarize Total = count(dcount_VulnId), sevH=countif(severity=='High'), sevM=countif(severity=='Medium'), sevL=countif(severity=='Low') by Resource\\r\\n| order by sevH desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Azure VMs with missing updates if Vulnerability Assessment is enabled in MDC\",\"exportFieldName\":\"Resource\",\"exportParameterName\":\"selectedResource\",\"exportDefaultValue\":\"All\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"sevH\",\"formatter\":4,\"formatOptions\":{\"palette\":\"redBright\"}},{\"columnMatch\":\"sevM\",\"formatter\":4,\"formatOptions\":{\"palette\":\"yellow\"}},{\"columnMatch\":\"sevL\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blueDark\"}}],\"filter\":true,\"labelSettings\":[{\"columnId\":\"sevH\",\"label\":\"High\"},{\"columnId\":\"sevM\",\"label\":\"Medium\"},{\"columnId\":\"sevL\",\"label\":\"Low\"}]}},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"vmrecom\"},\"name\":\"updatesummary\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"securityresources\\r\\n| where type == \\\"microsoft.security/assessments/subassessments\\\"\\r\\n| extend assessmentKey = extract(\\\".*assessments/(.+?)/.*\\\",1,  id)\\r\\n//| where assessmentKey == \\\"4ab6e3c5-74dd-8b35-9ab9-f61b30875b27\\\"\\r\\n| where assessmentKey == \\\"1195afff-c881-495e-9bc5-1486211ae03f\\\"\\r\\n| project   Severity = tostring(properties.status.severity),\\r\\n            Resource = iif(isempty(properties.resourceDetails.id),strcat(split(properties.resourceDetails.workspaceId, '/')[8]), properties.resourceDetails.id),\\r\\n            ResourceGroup = toupper(substring(id, 0, indexof(id, '/providers'))),\\r\\n\\t\\t\\tSource = tostring(properties.resourceDetails.source),\\r\\n\\t\\t\\tDescription = tostring(properties.description),\\r\\n\\t\\t\\tOperatingSystem = tostring(properties.additionalData.data.OperatingSystem),\\r\\n\\t\\t\\tOsType = tostring(properties.additionalData.data.OsType),\\r\\n\\t\\t\\tRebootBehavior = tostring(properties.additionalData.data.RebootBehavior),\\r\\n\\t\\t\\tPublishedDate = tostring(properties.additionalData.data.PublishedDate),\\r\\n\\t\\t\\tCategory = tostring(properties.category),\\r\\n            Remediation = properties.remediation,\\r\\n            RemediationSteps = \\\"info\\\"\\r\\n| where '{selectedResource}' == 'All' or Resource == '{selectedResource}'\\r\\n| order by Severity asc\",\"size\":0,\"showAnalytics\":true,\"title\":\"List of missing updates for the selected machine \",\"noDataMessage\":\"Select Machine from system with missing updates\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"Severity\",\"formatter\":5},{\"columnMatch\":\"Resource\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"showIcon\":true,\"bladeOpenContext\":{\"bladeName\":\"GenericResourceHealthDetailsBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"resourceId\",\"source\":\"cell\",\"value\":\"\"}]}}},{\"columnMatch\":\"ResourceGroup\",\"formatter\":14,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true,\"customColumnWidthSetting\":\"25ch\"}},{\"columnMatch\":\"Remediation\",\"formatter\":5},{\"columnMatch\":\"RemediationSteps\",\"formatter\":11,\"formatOptions\":{\"linkColumn\":\"Remediation\",\"linkTarget\":\"Url\"},\"tooltipFormat\":{\"tooltip\":\"Click to view remediation steps\"}},{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}}],\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Severity\"]}}},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"vmrecom\"},\"name\":\"updatelist\"},{\"type\":1,\"content\":{\"json\":\"NOTE: Review Service Principals with High Privileges (User Access Administrator, Owner, Contributor etc).  You can verify them by searching them in Azure AD overview page. This list also includes Idenitites used by Policy Assignements, Managed Identities in Logic Apps etc.You can see the associated resource in the properties section of the Managed Identity. \",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"account\"},\"name\":\"ServiceprincipalGapAnalysis\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"authorizationresources\\r\\n|where type =~'microsoft.authorization/roleassignments'\\r\\n| extend roleDefinitionId=tolower(tostring(properties.roleDefinitionId))\\r\\n| extend principalType =properties.principalType\\r\\n| extend principalId =properties.principalId\\r\\n| extend  scope =properties.scope\\r\\n|where principalType =~'ServicePrincipal'and properties.createdBy !=\\\"\\\"\\r\\n|join kind =inner (\\r\\nauthorizationresources\\r\\n|where type =~'microsoft.authorization/roledefinitions'\\r\\n|extend roleDefinitionId =tolower(id), roleName =tostring(properties.roleName)\\r\\n|extend Type =properties.type\\r\\n|project roleDefinitionId,roleName, Type\\r\\n) on roleDefinitionId\\r\\n//| join kind=inner (\\r\\n//resources\\r\\n//| where identity has  'SystemAssigned'\\r\\n//| extend principalId =properties.principalId\\r\\n//| project  principalId, name, Resource=id, type,resourceGroup, subscriptionId, identity.type) on principalId\\r\\n| project principalId, roleName, roleDefinitionId, scope, Type\\r\\n| distinct tostring(principalId), roleName, tostring(scope), tostring(Type)\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"List of Service Principals and their roles\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"account\"},\"name\":\"List of Service Principals and their roles\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where identity has  'SystemAssigned'\\r\\n| project  principalId=identity.principalId, name, Resource=id, type,resourceGroup, subscriptionId, identity.type\",\"size\":0,\"showAnalytics\":true,\"title\":\"Resources with System Assigned  Identity\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"account\"},\"name\":\"Resources with System Assigned  Identity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"35f35ddf-da7b-4248-b3dc-031efa3b508e\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"List of Service Principals and their roles\\\",\\\"rightTable\\\":\\\"Resources with System Assigned  Identity\\\",\\\"leftColumn\\\":\\\"principalId\\\",\\\"rightColumn\\\":\\\"principalId\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[List of Service Principals and their roles].principalId\\\",\\\"mergedName\\\":\\\"principalId\\\",\\\"fromId\\\":\\\"35f35ddf-da7b-4248-b3dc-031efa3b508e\\\"},{\\\"originalName\\\":\\\"[List of Service Principals and their roles].roleName\\\",\\\"mergedName\\\":\\\"roleName\\\",\\\"fromId\\\":\\\"35f35ddf-da7b-4248-b3dc-031efa3b508e\\\"},{\\\"originalName\\\":\\\"[List of Service Principals and their roles].scope\\\",\\\"mergedName\\\":\\\"scope\\\",\\\"fromId\\\":\\\"35f35ddf-da7b-4248-b3dc-031efa3b508e\\\"},{\\\"originalName\\\":\\\"[List of Service Principals and their roles].Type\\\",\\\"mergedName\\\":\\\"Type\\\",\\\"fromId\\\":\\\"35f35ddf-da7b-4248-b3dc-031efa3b508e\\\"},{\\\"originalName\\\":\\\"[Resources with System Assigned  Identity].principalId\\\",\\\"mergedName\\\":\\\"principalId1\\\",\\\"fromId\\\":\\\"35f35ddf-da7b-4248-b3dc-031efa3b508e\\\"},{\\\"originalName\\\":\\\"[Resources with System Assigned  Identity].name\\\",\\\"mergedName\\\":\\\"name\\\",\\\"fromId\\\":\\\"35f35ddf-da7b-4248-b3dc-031efa3b508e\\\"},{\\\"originalName\\\":\\\"[Resources with System Assigned  Identity].Resource\\\",\\\"mergedName\\\":\\\"Resource\\\",\\\"fromId\\\":\\\"35f35ddf-da7b-4248-b3dc-031efa3b508e\\\"},{\\\"originalName\\\":\\\"[Resources with System Assigned  Identity].type\\\",\\\"mergedName\\\":\\\"type\\\",\\\"fromId\\\":\\\"35f35ddf-da7b-4248-b3dc-031efa3b508e\\\"},{\\\"originalName\\\":\\\"[Resources with System Assigned  Identity].resourceGroup\\\",\\\"mergedName\\\":\\\"resourceGroup\\\",\\\"fromId\\\":\\\"35f35ddf-da7b-4248-b3dc-031efa3b508e\\\"},{\\\"originalName\\\":\\\"[Resources with System Assigned  Identity].subscriptionId\\\",\\\"mergedName\\\":\\\"subscriptionId\\\",\\\"fromId\\\":\\\"35f35ddf-da7b-4248-b3dc-031efa3b508e\\\"},{\\\"originalName\\\":\\\"[Resources with System Assigned  Identity].identity_type\\\",\\\"mergedName\\\":\\\"identity_type\\\",\\\"fromId\\\":\\\"35f35ddf-da7b-4248-b3dc-031efa3b508e\\\"},{\\\"originalName\\\":\\\"[Resources with System Assigned  Identity].principalId\\\"},{\\\"originalName\\\":\\\"[Resources with System Assigned  Identity].name\\\"}]}\",\"size\":0,\"showAnalytics\":true,\"title\":\"System Assigned Idenity-Permission-Associated Resources\",\"showExportToExcel\":true,\"queryType\":7,\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"account\"},\"name\":\"Service Principal-Permission-Associated Resources\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where identity has  'UserAssigned'\\r\\n| project  principalId=identity.principalId, name, Resource=id, type,resourceGroup, subscriptionId, identity.type\",\"size\":0,\"showAnalytics\":true,\"title\":\"Resources with User Assigned  Identity\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"account\"},\"name\":\"Resources with User Assigned  Identity \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"RecoveryServicesResources \\r\\n| where type in~ ('Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems')\\r\\n| extend vaultName = case(type =~ 'microsoft.dataprotection/backupVaults/backupInstances',split(split(id, '/Microsoft.DataProtection/backupVaults/')[1],'/')[0],type =~ 'Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems',split(split(id, '/Microsoft.RecoveryServices/vaults/')[1],'/')[0],'--')\\r\\n| extend dataSourceType = case(type=~'Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems',properties.backupManagementType,type =~ 'microsoft.dataprotection/backupVaults/backupInstances',properties.dataSourceSetInfo.datasourceType,'--')\\r\\n| extend friendlyName = properties.friendlyName\\r\\n| extend dsResourceGroup = split(split(properties.dataSourceInfo.resourceID, '/resourceGroups/')[1],'/')[0]\\r\\n| extend dsSubscription = split(split(properties.dataSourceInfo.resourceID, '/subscriptions/')[1],'/')[0]\\r\\n| extend lastRestorePoint = properties.lastRecoveryPoint\\r\\n| extend primaryLocation = properties.dataSourceInfo.resourceLocation\\r\\n| extend policyName = case(type =~ 'Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems',properties.policyName, type =~ 'microsoft.dataprotection/backupVaults/backupInstances', properties.policyInfo.name, '--')\\r\\n| extend protectionState = properties.currentProtectionState\\r\\n| where protectionState in~ ('ConfiguringProtection','ProtectionConfigured','ConfiguringProtectionFailed','ProtectionStopped','SoftDeleted','ProtectionError')\\r\\n| project id, vaultName, dataSourceType, friendlyName,dsResourceGroup, subscriptionId, lastRestorePoint, primaryLocation, policyName, protectionState, tags\",\"size\":0,\"showAnalytics\":true,\"title\":\"List all Azure VMs that have  been configured for backup\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"backup\"},\"name\":\"backupVMslist\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Resources\\r\\n| where type in~ ('microsoft.compute/virtualmachines','microsoft.classiccompute/virtualmachines') \\r\\n| extend resourceId=tolower(id) \\r\\n| join kind = leftouter ( RecoveryServicesResources\\r\\n| where type == \\\"microsoft.recoveryservices/vaults/backupfabrics/protectioncontainers/protecteditems\\\"\\r\\n| where properties.backupManagementType == \\\"AzureIaasVM\\\"\\r\\n| project resourceId = tolower(tostring(properties.sourceResourceId)), backupItemid = id, isBackedUp = isnotempty(id) ) on resourceId \\r\\n| extend isProtected = isnotempty(backupItemid)\\r\\n| where (isProtected == (0))\\r\\n| project id,name,resourceGroup,location,tags, subscriptionId\",\"size\":0,\"showAnalytics\":true,\"title\":\"List all Azure VMs that have not  been configured for backup\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"backup\"},\"name\":\"NobackupVMslist \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"RecoveryServicesResources\\r\\n| where type == 'microsoft.recoveryservices/vaults/backuppolicies'\\r\\n| extend vaultName = case(type == 'microsoft.recoveryservices/vaults/backuppolicies', split(split(id, 'microsoft.recoveryservices/vaults/')[1],'/')[0],type == 'microsoft.recoveryservices/vaults/backuppolicies', split(split(id, 'microsoft.recoveryservices/vaults/')[1],'/')[0],'--')\\r\\n| extend datasourceType = case(type == 'microsoft.recoveryservices/vaults/backuppolicies', properties.backupManagementType,type == 'microsoft.dataprotection/backupVaults/backupPolicies',properties.datasourceTypes[0],'--')\\r\\n| project id,name,vaultName,resourceGroup,properties,datasourceType\\r\\n//| where datasourceType == 'AzureIaasVM'\",\"size\":0,\"showAnalytics\":true,\"title\":\"List of Backup policies \",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"backup\"},\"name\":\"backuppolicy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"RecoveryServicesResources \\r\\n| where type in~ ('Microsoft.DataProtection/backupVaults/backupJobs', 'microsoft.recoveryservices/vaults/backupjobs')\\r\\n| extend vaultName = case(type =~ 'microsoft.dataprotection/backupVaults/backupJobs',properties.vaultName,type =~ 'Microsoft.RecoveryServices/vaults/backupJobs',split(split(id, '/Microsoft.RecoveryServices/vaults/')[1],'/')[0],'--')\\r\\n| extend friendlyName = case(type =~ 'microsoft.dataprotection/backupVaults/backupJobs',strcat(properties.dataSourceSetName , '/', properties.dataSourceName),type =~ 'Microsoft.RecoveryServices/vaults/backupJobs', properties.entityFriendlyName, '--')\\r\\n| extend dataSourceType = case(type =~ 'Microsoft.RecoveryServices/vaults/backupJobs',properties.backupManagementType,type =~ 'microsoft.dataprotection/backupVaults/backupJobs',properties.dataSourceType,'--')\\r\\n| extend backupInstanceName = properties.backupInstanceId\\r\\n| extend dsResourceGroup = split(split(properties.dataSourceId, '/resourceGroups/')[1],'/')[0]| extend dsSubscription = split(split(properties.dataSourceId, '/subscriptions/')[1],'/')[0]\\r\\n| extend status = properties.status\\r\\n| extend dataSourceId = properties.dataSourceId\\r\\n| extend primaryLocation = properties.dataSourceLocation\\r\\n| extend jobStatus = case (properties.status == 'Completed' or properties.status == 'CompletedWithWarnings','Succeeded',properties.status == 'Failed','Failed',properties.status == 'InProgress', 'Started', properties.status), operation = case(type =~ 'microsoft.dataprotection/backupVaults/backupJobs' and tolower(properties.operationCategory) =~ 'backup' and properties.isUserTriggered == 'true',strcat('adhoc',properties.operationCategory),type =~ 'microsoft.dataprotection/backupVaults/backupJobs', tolower(properties.operationCategory), type =~ 'Microsoft.RecoveryServices/vaults/backupJobs' and tolower(properties.operation) =~ 'backup' and properties.isUserTriggered == 'true',strcat('adhoc',properties.operation),type =~ 'Microsoft.RecoveryServices/vaults/backupJobs',tolower(properties.operation), '--'),startTime = todatetime(properties.startTime),endTime = properties.endTime, duration = properties.duration\\r\\n| project id, name, friendlyName, resourceGroup, vaultName, dataSourceType, operation, jobStatus, startTime, duration, backupInstanceName, dsResourceGroup, dsSubscription, status, primaryLocation, dataSourceId\\r\\n//| where  (dsSubscription in~ ({SubscriptionName})) //and (dataSourceType in~ ('Microsoft.DBforPostgreSQL/servers/databases')) and (status in~ ('Started','InProgress','Succeeded','Completed','Failed','CompletedWithWarnings')) and (operation in~ ('adhocBackup','backup')) //add the relevant subscription ids you wish to query to this line\\r\\n| where (startTime >= ago(7d))\",\"size\":0,\"showAnalytics\":true,\"title\":\"List of Backup jobs in last one week\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"backup\"},\"name\":\"backupjob\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"recoveryservicesresources\\r\\n| where type in~ ('microsoft.recoveryservices/vaults/alerts')\\r\\n| where subscriptionId in~ ({SubscriptionName})\\r\\n| extend Alerttitle= properties.alertTitle, SourceType= properties.sourceType, AffetcedItem= properties.affectedItems, TimeGenerated= properties.initialOccurrenceTime\\r\\n| project id, TimeGenerated ,Alerttitle, AffetcedItem, SourceType, resourceGroup, subscriptionId\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"List all Backup alerts\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"backup\"},\"name\":\"backupalerts\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.azurearcdata/sqlserverinstances/databases\\\"\\r\\n| where name != \\\"tempdb\\\"\\r\\n| extend prop_db=parse_xml(properties) \\r\\n| extend prop_db_recoveryMode = prop_db.recoveryMode\\r\\n| extend prop_db_databaseCreationDate = todatetime(prop_db.databaseCreationDate)\\r\\n| extend prop_db_backupInformation = prop_db.backupInformation\\r\\n| extend prop_db_backupInformation_lastFullBackup = todatetime(prop_db.backupInformation.lastFullBackup)\\r\\n| extend calc_lastBackupAgeDays = iff(\\r\\n                                        isnull(prop_db_backupInformation_lastFullBackup),\\r\\n                                        datetime_diff('Day', now(), prop_db_databaseCreationDate),\\r\\n                                        datetime_diff('Day', now(), prop_db_backupInformation_lastFullBackup)\\r\\n                                    )\\r\\n//| where todatetime(prop_db.backupInformation.lastFullBackup) > ago(24h)\\r\\n| where calc_lastBackupAgeDays > 1\\r\\n| project ['id'], RecoveryModel = prop_db_recoveryMode, LastFullBackup = prop_db_backupInformation_lastFullBackup , DaysSinceLastFullBackup = calc_lastBackupAgeDays\\r\\n| sort by DaysSinceLastFullBackup\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Azure Arc SQL Databases since last full backup \",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"backup\"},\"name\":\"Arcsqlbackup\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.compute/disks\\\"\\r\\n| extend encryptionstatus= properties.encryption.type\\r\\n| project id, name, resourceGroup, subscriptionId, PublicNetworkAccess=properties.publicNetworkAccess, encryptionstatus,Size= properties.diskSizeGB, OS= properties.osType\",\"size\":0,\"showAnalytics\":true,\"title\":\"Disk Encryption Status\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"encrypt\"},\"name\":\"encyption status\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resourcechanges\\r\\n| extend changeTime = todatetime(properties.changeAttributes.timestamp)\\r\\n| project\\r\\n    ['Change time'] = changeTime,\\r\\n    ['Change type'] = properties.changeType,\\r\\n    id = properties.targetResourceId,\\r\\n    type = properties.targetResourceType,\\r\\n    Changes = properties.changes,\\r\\n    resourceGroup,\\r\\n    subscriptionId\\r\\n| union kind = inner \\r\\n    (\\r\\n    resourcecontainerchanges\\r\\n    | extend changeTime = todatetime(properties.changeAttributes.timestamp)\\r\\n    | project\\r\\n        ['Change time'] = changeTime,\\r\\n        ['Change type'] = properties.changeType,\\r\\n        id = properties.targetResourceId,\\r\\n        type = properties.targetResourceType,\\r\\n        Changes = properties.changeAttributes,\\r\\n        resourceGroup,\\r\\n        subscriptionId\\r\\n    )\\r\\n| order by ['Change time'] desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Resource Configuration Changes in the last 14 days\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"],\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"change\"},\"name\":\"changes\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resourcechanges\\r\\n| extend changeTime = todatetime(properties.changeAttributes.timestamp), targetResourceId = tostring(properties.targetResourceId),\\r\\nchangeType = tostring(properties.changeType), correlationId = properties.changeAttributes.correlationId\\r\\n| where changeType =~ \\\"Delete\\\"\\r\\n| order by changeTime desc\\r\\n| project changeTime, resourceGroup, targetResourceId, changeType, correlationId\",\"size\":0,\"showAnalytics\":true,\"title\":\"Resource Deleted in the last 14 days\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{SubscriptionName}\"]},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"change\"},\"name\":\"changes - delete\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"Below table provides the the number of principals assigned the same role and at the same scope. Review the count and replace the multiple principal based role assignments with a single role assignment for a group as applicable. This will help to limit reaching the role assignments quota (4000 role assignments) in a subscription. You can get more details about the principals by searching them in Azure AD overview page.\",\"style\":\"info\"},\"name\":\"text -GroupsElligibility\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuthorizationResources\\r\\n| where type =~ \\\"microsoft.authorization/roleassignments\\\"\\r\\n| where id startswith \\\"/subscriptions\\\"\\r\\n| extend RoleId = tolower(tostring(properties.roleDefinitionId))\\r\\n| join kind = leftouter (\\r\\n  AuthorizationResources\\r\\n  | where type =~ \\\"microsoft.authorization/roledefinitions\\\"\\r\\n  | extend RoleDefinitionName = tostring(properties.roleName)\\r\\n  | extend RoleId = tolower(id)\\r\\n  | project RoleDefinitionName, RoleId\\r\\n) on $left.RoleId == $right.RoleId\\r\\n| extend principalId = tostring(properties.principalId)\\r\\n| extend principal_to_ra = pack(principalId, id)\\r\\n| summarize count_ = count(), AllPrincipals = make_set(principal_to_ra) by RoleDefinitionName,RoleDefinitionId = RoleId, Scope = tolower(properties.scope)\\r\\n| where count_ > 1\\r\\n| order by count_ desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Review  principal-based role assignments with group-based role assignments\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"]},\"name\":\"GroupElligibility\"},{\"type\":1,\"content\":{\"json\":\"Below table provides the role assignments with the same role and same principal, but at different scopes. Review the scopes and identify where redundant role assignments at a lower scope can potentially be removed since a role assignment at a higher scope already grants access.This will help to limit reaching the role assignments quota (4000 role assignments) in a subscription. You can get more details about the principals by searching them in Azure AD overview page.\",\"style\":\"info\"},\"name\":\"text - redundantrole\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuthorizationResources\\r\\n| where type =~ \\\"microsoft.authorization/roleassignments\\\"\\r\\n| where id startswith \\\"/subscriptions\\\"\\r\\n| extend RoleDefinitionId = tolower(tostring(properties.roleDefinitionId))\\r\\n| extend PrincipalId = tolower(properties.principalId)\\r\\n| extend RoleDefinitionId_PrincipalId = strcat(RoleDefinitionId, \\\"_\\\", PrincipalId)\\r\\n| join kind = leftouter (\\r\\n  AuthorizationResources\\r\\n  | where type =~ \\\"microsoft.authorization/roledefinitions\\\"\\r\\n  | extend RoleDefinitionName = tostring(properties.roleName)\\r\\n  | extend rdId = tolower(id)\\r\\n  | project RoleDefinitionName, rdId\\r\\n) on $left.RoleDefinitionId == $right.rdId\\r\\n| summarize count_ = count(), Scopes = make_set(tolower(properties.scope)) by RoleDefinitionId_PrincipalId,RoleDefinitionName\\r\\n| project RoleDefinitionName,RoleDefinitionId = split(RoleDefinitionId_PrincipalId, \\\"_\\\", 0)[0],  PrincipalId = split(RoleDefinitionId_PrincipalId, \\\"_\\\", 1)[0], count_, Scopes\\r\\n| where count_ > 1\\r\\n| order by count_ desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Review redundant role assignments\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"]},\"name\":\"redundantrole\"},{\"type\":1,\"content\":{\"json\":\"Below table provides the number of different built-in role assignments with the same principal and same scope. Review the roles. You can get more details about the principals by searching them in Azure AD overview page.\",\"style\":\"info\"},\"name\":\"text - multipleroles\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuthorizationResources\\r\\n| where type =~ \\\"microsoft.authorization/roleassignments\\\"\\r\\n| where id startswith \\\"/subscriptions\\\"\\r\\n| extend PrincipalId = tostring(properties.principalId) \\r\\n| extend Scope = tolower(properties.scope)\\r\\n| extend RoleDefinitionId = tolower(tostring(properties.roleDefinitionId))\\r\\n| join kind = leftouter (\\r\\n  AuthorizationResources\\r\\n  | where type =~ \\\"microsoft.authorization/roledefinitions\\\"\\r\\n  | extend RoleName = tostring(properties.roleName)\\r\\n  | extend RoleId = tolower(id)\\r\\n  | extend RoleType = tostring(properties.type) \\r\\n  | where RoleType == \\\"BuiltInRole\\\"\\r\\n  | extend RoleId_RoleName = pack(RoleId, RoleName)\\r\\n) on $left.RoleDefinitionId == $right.RoleId\\r\\n| summarize count_ = count(), Roles = make_set(RoleId_RoleName) by PrincipalId, Scope\\r\\n| where count_ > 1\\r\\n| order by count_ desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Review  the role assignments per principal\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"]},\"name\":\"multipleroles\"}]},\"conditionalVisibility\":{\"parameterName\":\"vmtab\",\"comparison\":\"isEqualTo\",\"value\":\"rbac\"},\"name\":\"RBAC\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"azure monitor\"]}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}

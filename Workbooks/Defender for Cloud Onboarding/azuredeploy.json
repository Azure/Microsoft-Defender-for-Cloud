{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Defender for Cloud Onboarding",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "Azure Security Center",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "variables": {
    "workbookContent": {
      "version": "Notebook/1.0",
      "items": [
        {
          "type": 1,
          "content": {
            "json": "## Onboarding Defender for Cloud\r\n This Workbook checks if all your subscriptions under your Tenant are onboarded with Defender for Cloud, Defender for Cloud Plans currently enabled across your subscriptions and Log Analytics Workspaces, Lists the resources deployed into these subscriptions that can be protected with Defender for Cloud workload protection plans, checks if any onboarding agents are missing for the workload protection.\r\n\r\n <svg viewBox=\"0 0 19 19\" width=\"20\" class=\"fxt-escapeShadow\" role=\"presentation\" focusable=\"false\" xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\"><g><path fill=\"#1b93eb\" d=\"M16.82 8.886c0 4.81-5.752 8.574-7.006 9.411a.477.477 0 01-.523 0C8.036 17.565 2.18 13.7 2.18 8.886V3.135a.451.451 0 01.42-.419C7.2 2.612 6.154.625 9.5.625s2.3 1.987 6.8 2.091a.479.479 0 01.523.419z\"></path><path fill=\"url(#0024423711759027356)\" d=\"M16.192 8.99c0 4.392-5.333 7.947-6.483 8.575a.319.319 0 01-.418 0c-1.15-.732-6.483-4.183-6.483-8.575V3.762a.575.575 0 01.313-.523C7.2 3.135 6.258 1.357 9.4 1.357s2.2 1.882 6.274 1.882a.45.45 0 01.419.418z\"></path><path d=\"M9.219 5.378a.313.313 0 01.562 0l.875 1.772a.314.314 0 00.236.172l1.957.284a.314.314 0 01.174.535l-1.416 1.38a.312.312 0 00-.09.278l.334 1.949a.313.313 0 01-.455.33l-1.75-.92a.314.314 0 00-.292 0l-1.75.92a.313.313 0 01-.455-.33L7.483 9.8a.312.312 0 00-.09-.278L5.977 8.141a.314.314 0 01.174-.535l1.957-.284a.314.314 0 00.236-.172z\" class=\"msportalfx-svg-c01\"></path></g></svg>&nbsp;<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px 0px 0px 0px;position: relative;top:-3px;left:-4px;\"> Please take the time to answer a quick survey. To submit your feedback,\r\n</span>[<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px 0px 0px 0px;position: relative;top:-3px;left:-4px;\"> click here. </span>](https://aka.ms/MDFCOnboardingSurvey)"
          },
          "customWidth": "100",
          "name": "text - Title",
          "styleSettings": {
            "margin": "0px",
            "padding": "0px"
          }
        },
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "parameters": [
              {
                "id": "7a8be0a4-2557-43c9-afb5-9e3c9fdc11f7",
                "version": "KqlParameterItem/1.0",
                "name": "Subscriptions",
                "type": 6,
                "isRequired": true,
                "multiSelect": true,
                "quote": "'",
                "delimiter": ",",
                "value": [
                  "value::all"
                ],
                "typeSettings": {
                  "additionalResourceOptions": [
                    "value::all"
                  ],
                  "includeAll": true,
                  "showDefault": false
                }
              },
              {
                "id": "d4e04df2-4d8b-4127-b769-de821c7895db",
                "version": "KqlParameterItem/1.0",
                "name": "info",
                "label": "Additional information",
                "type": 10,
                "isRequired": true,
                "value": "Off",
                "typeSettings": {
                  "additionalResourceOptions": []
                },
                "jsonData": "[[\n { \"value\": \"On\", \"label\": \"On\"},\n { \"value\": \"Off\", \"label\": \"Off\"}\n]",
                "timeContext": {
                  "durationMs": 86400000
                }
              }
            ],
            "style": "above",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          "name": "info"
        },
        {
          "type": 1,
          "content": {
            "json": "## Release notes\r\n\r\n|Version|Description|Date|\r\n|---|---|---|\r\n|v1.0|initial release, public availability of Defender for Cloud Onboarding Workbook|8/10/2022|"
          },
          "conditionalVisibility": {
            "parameterName": "info",
            "comparison": "isEqualTo",
            "value": "On"
          },
          "name": "info"
        },
        {
          "type": 11,
          "content": {
            "version": "LinkItem/1.0",
            "style": "tabs",
            "tabStyle": "bigger",
            "links": [
              {
                "id": "9492db35-96c2-4ada-b726-8aac379a06c3",
                "cellValue": "Tabselected",
                "linkTarget": "parameter",
                "linkLabel": "Subscription Onboarding",
                "subTarget": "SubscriptionList",
                "preText": "Subscriptions",
                "style": "link"
              },
              {
                "id": "d00c6be6-71c6-4b34-b2ed-94259dbba5e2",
                "cellValue": "Tabselected",
                "linkTarget": "parameter",
                "linkLabel": "Defender Plans Onboarded",
                "subTarget": "DefenderPlansList",
                "style": "link"
              },
              {
                "id": "157aad7c-e377-4c80-8b5b-45276eafc75f",
                "cellValue": "Tabselected",
                "linkTarget": "parameter",
                "linkLabel": "Onboarding Agents Health",
                "subTarget": "AgentHealth",
                "style": "link"
              }
            ]
          },
          "name": "links -tabs3"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "items": [
              {
                "type": 1,
                "content": {
                  "json": "## Subscriptions Onboarded to Defender for Cloud"
                },
                "customWidth": "50",
                "name": "text-subscriptionlisting - Copy",
                "styleSettings": {
                  "margin": "10px",
                  "padding": "10px"
                }
              },
              {
                "type": 1,
                "content": {
                  "json": "## Subscriptions which are NOT Onboarded to Defender for Cloud"
                },
                "customWidth": "50",
                "name": "text-subscriptionlisting",
                "styleSettings": {
                  "margin": "10px",
                  "padding": "10px"
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "ResourceContainers\r\n| where type =~ 'microsoft.resources/subscriptions'\r\n| project subscriptionId",
                  "size": 0,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ]
                },
                "conditionalVisibility": {
                  "parameterName": "subscriptionId",
                  "comparison": "isEqualTo",
                  "value": "Nil"
                },
                "name": "query-listAllSubscriptions"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "SecurityResources\r\n| where type == 'microsoft.security/securescores'\r\n| summarize by Subscription=subscriptionId",
                  "size": 1,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "Subscription",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "subscriptionId",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      }
                    ]
                  }
                },
                "customWidth": "50",
                "name": "query-listsecurityresources"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"1950236d-8dd3-4b6e-a554-1c89be4d1051\",\"mergeType\":\"leftanti\",\"leftTable\":\"query-listAllSubscriptions\",\"rightTable\":\"query-listsecurityresources\",\"leftColumn\":\"subscriptionId\",\"rightColumn\":\"Subscription\"}],\"projectRename\":[{\"originalName\":\"[query-listAllSubscriptions].subscriptionId\",\"mergedName\":\"Subscription\",\"fromId\":\"1950236d-8dd3-4b6e-a554-1c89be4d1051\"}]}",
                  "size": 1,
                  "queryType": 7,
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "Subscription",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true,
                          "bladeOpenContext": {
                            "bladeName": "SubscriptionsBlade",
                            "extensionName": "Microsoft_Azure_Billing",
                            "bladeParameters": [
                              {
                                "name": "subscriptionId",
                                "source": "column",
                                "value": "subscriptionId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "Check ",
                        "formatter": 1,
                        "formatOptions": {
                          "linkColumn": "subscriptionId",
                          "linkTarget": "OpenBlade",
                          "bladeOpenContext": {
                            "bladeName": "SubscriptionsBlade",
                            "extensionName": "Microsoft_Azure_Billing",
                            "bladeParameters": [
                              {
                                "name": "subscriptionId",
                                "source": "column",
                                "value": "subscriptionId"
                              }
                            ]
                          }
                        }
                      }
                    ]
                  }
                },
                "customWidth": "45",
                "showPin": false,
                "name": "query - 3"
              },
              {
                "type": 1,
                "content": {
                  "json": "### [Check User Access](https://ms.portal.azure.com/#view/Microsoft_Azure_Billing/SubscriptionsBlade) Permissions to onboard Defender for Cloud to your subscriptions.\r\n###  [Click here](https://ms.portal.azure.com/#view/Microsoft_Azure_Policy/PolicyDetailBlade/definitionId/%2Fproviders%2FMicrosoft.Authorization%2FpolicyDefinitions%2Fac076320-ddcf-4066-b451-6154267e8ad2) to enable Defender for Cloud.  \r\nThis policy Identifies existing subscriptions that aren't monitored by Microsoft Defender for Cloud and protects them with Defender for Cloud's free features for your subscriptions\r\n",
                  "style": "info"
                },
                "name": "text-checkaccess"
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "Tabselected",
            "comparison": "isEqualTo",
            "value": "SubscriptionList"
          },
          "name": "group-Subscriptionlisting"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "items": [
              {
                "type": 1,
                "content": {
                  "json": "## Defender Plans in your Subscriptions onboarded to Defender for Cloud"
                },
                "name": "text - DefenderPlans"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "tabs",
                  "tabStyle": "bigger",
                  "links": [
                    {
                      "id": "eff91d4f-7a60-42c9-8e8e-36ea0aa7b54f",
                      "cellValue": "DefenderPlan",
                      "linkTarget": "parameter",
                      "linkLabel": "Servers",
                      "subTarget": "Servers",
                      "preText": "Servers",
                      "postText": "DefenderPlan",
                      "style": "link"
                    },
                    {
                      "id": "f790ccb9-90ae-4ea3-8db4-9876b44a414d",
                      "cellValue": "DefenderPlan",
                      "linkTarget": "parameter",
                      "linkLabel": "AppService",
                      "subTarget": "AppService",
                      "style": "link"
                    },
                    {
                      "id": "59dcf957-f013-4afd-8ea1-ee823d345e69",
                      "cellValue": "DefenderPlan",
                      "linkTarget": "parameter",
                      "linkLabel": "Databases",
                      "subTarget": "Databases",
                      "style": "link"
                    },
                    {
                      "id": "8740e53c-5735-4ea8-aaf9-9e0c497c8423",
                      "cellValue": "DefenderPlan",
                      "linkTarget": "parameter",
                      "linkLabel": "Storage",
                      "subTarget": "Storage",
                      "style": "link"
                    },
                    {
                      "id": "8f85be9b-454b-4969-b839-95baf1a1de2b",
                      "cellValue": "DefenderPlan",
                      "linkTarget": "parameter",
                      "linkLabel": "Containers",
                      "subTarget": "Containers",
                      "style": "link"
                    },
                    {
                      "id": "7fe42ae2-3b8a-4f32-bba3-a8fa5b1db79e",
                      "cellValue": "DefenderPlan",
                      "linkTarget": "parameter",
                      "linkLabel": "Key Vault",
                      "subTarget": "KeyVault",
                      "style": "link"
                    },
                    {
                      "id": "007699e8-e364-4ded-8e89-89a5a065e220",
                      "cellValue": "DefenderPlan",
                      "linkTarget": "parameter",
                      "linkLabel": "Resource Manager",
                      "subTarget": "ARM",
                      "style": "link"
                    },
                    {
                      "id": "5f80c701-f9a5-4a56-aad3-79ce2bc1157f",
                      "cellValue": "DefenderPlan",
                      "linkTarget": "parameter",
                      "linkLabel": "DNS",
                      "subTarget": "DNS",
                      "style": "link"
                    }
                  ]
                },
                "name": "links - DefenderPlan"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "tabs",
                  "links": [
                    {
                      "id": "806b6315-17c8-46d2-8ef3-4a473e25f06d",
                      "cellValue": "DatabasePlan",
                      "linkTarget": "parameter",
                      "linkLabel": "Azure SQL Databases",
                      "subTarget": "AzureSQL",
                      "style": "link"
                    },
                    {
                      "id": "0fc560e7-de0d-4c45-a224-c97f7554fe94",
                      "cellValue": "DatabasePlan",
                      "linkTarget": "parameter",
                      "linkLabel": "SQL servers on machines",
                      "subTarget": "SQLVMS",
                      "style": "link"
                    },
                    {
                      "id": "15c25274-20cc-4376-9d53-7bb9010253b0",
                      "cellValue": "DatabasePlan",
                      "linkTarget": "parameter",
                      "linkLabel": "Open-source relational databases",
                      "subTarget": "OSSDB",
                      "style": "link"
                    },
                    {
                      "id": "d8b9926e-4a63-4c30-a739-69d34fcd5901",
                      "cellValue": "DatabasePlan",
                      "linkTarget": "parameter",
                      "linkLabel": "Azure Cosmos DB (preview)",
                      "subTarget": "COSMOSDB",
                      "style": "link"
                    }
                  ]
                },
                "customWidth": "100",
                "conditionalVisibility": {
                  "parameterName": "DefenderPlan",
                  "comparison": "isEqualTo",
                  "value": "Databases"
                },
                "name": "links - DatabaseTypes"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "securityresources\r\n| where type =~ \"microsoft.security/pricings\" \r\n| where name =~ \"VirtualMachines\"\r\n| project subscriptionId, name, DefenderPlan=properties.pricingTier \r\n| join \r\n(Resources\r\n| where type in (\r\n 'microsoft.compute/virtualmachines',\r\n 'microsoft.compute/virtualmachinescalesets',\r\n 'microsoft.hybridcompute/machines'\r\n  )\r\n| summarize ServerResources=count() by  ResourceType=type, subscriptionId\r\n)\r\n on subscriptionId\r\n| project-away name, subscriptionId1\r\n| sort by subscriptionId\r\n",
                  "size": 1,
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "subscriptionId",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "DefenderPlan",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "subscriptionId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Standard",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "Free",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingWithBundlesBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "subscriptionId",
                                "source": "column",
                                "value": "subscriptionId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "Type",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "subscriptionId",
                        "label": "Subscription"
                      }
                    ]
                  }
                },
                "conditionalVisibility": {
                  "parameterName": "DefenderPlan",
                  "comparison": "isEqualTo",
                  "value": "Servers"
                },
                "name": "query - VirtualMachines"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "securityresources\r\n| where type =~ \"microsoft.security/pricings\" \r\n| where name =~ \"AppServices\"\r\n| project subscriptionId, name, DefenderPlan=properties.pricingTier \r\n| join \r\n(Resources\r\n| where type in (\r\n 'microsoft.web/sites'\r\n  )\r\n| summarize AppServiceResources=count() by  ResourceType=type, subscriptionId)\r\n on subscriptionId\r\n | project-away name, subscriptionId1\r\n| sort by subscriptionId",
                  "size": 1,
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "subscriptionId",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "DefenderPlan",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "subscriptionId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Standard",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "Free",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingWithBundlesBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "subscriptionId",
                                "source": "column",
                                "value": "subscriptionId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "ResourceType",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "subscriptionId",
                        "label": "Subscription"
                      }
                    ]
                  }
                },
                "conditionalVisibility": {
                  "parameterName": "DefenderPlan",
                  "comparison": "isEqualTo",
                  "value": "AppService"
                },
                "name": "query - AppServices"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "securityresources\r\n| where type =~ \"microsoft.security/pricings\" \r\n| where name =~ \"SqlServers\"\r\n| project subscriptionId, name, DefenderPlan=properties.pricingTier \r\n| join \r\n(Resources\r\n| where type in (\r\n 'microsoft.sql/servers',\r\n //'microsoft.sql/servers/databases',\r\n //'microsoft.sql/servers/elasticpools'\r\n 'microsoft.sql/managedinstances',\r\n 'microsoft.synapse/workspaces'\r\n\r\n  )\r\n| summarize SQLResources=count() by  ResourceType=type, subscriptionId\r\n)\r\n on subscriptionId\r\n| project-away name, subscriptionId1\r\n| sort by subscriptionId\r\n",
                  "size": 1,
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "subscriptionId",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "DefenderPlan",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "subscriptionId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Standard",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "Free",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingWithBundlesBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "subscriptionId",
                                "source": "column",
                                "value": "subscriptionId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "ResourceType",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "subscriptionId",
                        "label": "Subscription"
                      }
                    ]
                  }
                },
                "conditionalVisibilities": [
                  {
                    "parameterName": "DefenderPlan",
                    "comparison": "isEqualTo",
                    "value": "Databases"
                  },
                  {
                    "parameterName": "DatabasePlan",
                    "comparison": "isEqualTo",
                    "value": "AzureSQL"
                  }
                ],
                "name": "query - SqlServers"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "securityresources\r\n| where type =~ \"microsoft.security/pricings\" \r\n| where name =~ \"SqlServerVirtualMachines\"\r\n| project subscriptionId, name, DefenderPlan=properties.pricingTier \r\n| join \r\n(Resources\r\n| where type in (\r\n  'microsoft.sqlvirtualmachine/sqlvirtualmachines',\r\n  'microsoft.azurearcdata/sqlserverinstances'\r\n\r\n  )\r\n| summarize SQLVirtualMachines=count() by  ResourceType=type, subscriptionId\r\n)\r\n on subscriptionId\r\n| project-away name, subscriptionId1\r\n| sort by subscriptionId\r\n",
                  "size": 1,
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "subscriptionId",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "DefenderPlan",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "subscriptionId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Standard",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "Free",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingWithBundlesBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "subscriptionId",
                                "source": "column",
                                "value": "subscriptionId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "ResourceType",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "subscriptionId",
                        "label": "Subscription"
                      }
                    ]
                  }
                },
                "conditionalVisibilities": [
                  {
                    "parameterName": "DefenderPlan",
                    "comparison": "isEqualTo",
                    "value": "Databases"
                  },
                  {
                    "parameterName": "DatabasePlan",
                    "comparison": "isEqualTo",
                    "value": "SQLVMS"
                  }
                ],
                "name": "query - SQLVMS"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "securityresources\r\n| where type =~ \"microsoft.security/pricings\" \r\n| where name =~ \"OpenSourceRelationalDatabases\"\r\n| project subscriptionId, name, DefenderPlan=properties.pricingTier \r\n| join \r\n(Resources\r\n| where type in (\r\n  'microsoft.dbformariadb/servers',\r\n  'microsoft.dbformysql/servers',\r\n  'microsoft.dbforpostgresql/servers'\r\n  )\r\n| summarize OpenSourceDBs=count() by  ResourceType=type, subscriptionId\r\n)\r\n on subscriptionId\r\n| project-away name, subscriptionId1\r\n| sort by subscriptionId\r\n",
                  "size": 1,
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "subscriptionId",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "DefenderPlan",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "subscriptionId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Standard",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "Free",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingWithBundlesBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "subscriptionId",
                                "source": "column",
                                "value": "subscriptionId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "ResourceType",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "subscriptionId",
                        "label": "Subscription"
                      }
                    ]
                  }
                },
                "conditionalVisibilities": [
                  {
                    "parameterName": "DefenderPlan",
                    "comparison": "isEqualTo",
                    "value": "Databases"
                  },
                  {
                    "parameterName": "DatabasePlan",
                    "comparison": "isEqualTo",
                    "value": "OSSDB"
                  }
                ],
                "name": "query - opensourcedatabases"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "securityresources\r\n| where type =~ \"microsoft.security/pricings\" \r\n| where name =~ \"CosmosDbs\"\r\n| project subscriptionId, name, DefenderPlan=properties.pricingTier \r\n| join \r\n(Resources\r\n| where type in (\r\n  'microsoft.documentdb/databaseaccounts'\r\n  )\r\n| summarize CosmosDBs=count() by  ResourceType=type, subscriptionId\r\n)\r\n on subscriptionId\r\n| project-away name, subscriptionId1\r\n| sort by subscriptionId\r\n",
                  "size": 1,
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "subscriptionId",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "DefenderPlan",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "subscriptionId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Standard",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "Free",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingWithBundlesBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "subscriptionId",
                                "source": "column",
                                "value": "subscriptionId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "ResourceType",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "subscriptionId",
                        "label": "Subscription"
                      }
                    ]
                  }
                },
                "conditionalVisibilities": [
                  {
                    "parameterName": "DefenderPlan",
                    "comparison": "isEqualTo",
                    "value": "Databases"
                  },
                  {
                    "parameterName": "DatabasePlan",
                    "comparison": "isEqualTo",
                    "value": "COSMOSDB"
                  }
                ],
                "name": "query-cosmosdb"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "securityresources\r\n| where type =~ \"microsoft.security/pricings\" \r\n| where name =~ \"StorageAccounts\"\r\n| project subscriptionId, name, DefenderPlan=properties.pricingTier \r\n| join \r\n(Resources\r\n| where type in (\r\n 'microsoft.storage/storageaccounts',\r\n 'microsoft.databricks/workspaces'\r\n  )\r\n| summarize StorageResources=count() by  ResourceType=type, subscriptionId)\r\n on subscriptionId\r\n| project-away name, subscriptionId1\r\n| sort by subscriptionId",
                  "size": 1,
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "subscriptionId",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "DefenderPlan",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "subscriptionId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Standard",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "Free",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingWithBundlesBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "subscriptionId",
                                "source": "column",
                                "value": "subscriptionId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "ResourceType",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "subscriptionId",
                        "label": "Subscription"
                      }
                    ]
                  }
                },
                "conditionalVisibility": {
                  "parameterName": "DefenderPlan",
                  "comparison": "isEqualTo",
                  "value": "Storage"
                },
                "name": "query-StorageAccounts"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "securityresources\r\n| where type =~ \"microsoft.security/pricings\" \r\n| where name =~ \"Containers\"\r\n| project subscriptionId, name, DefenderPlan=properties.pricingTier \r\n| join \r\n(Resources\r\n| where type in (\r\n 'microsoft.containerregistry/registries',\r\n 'microsoft.containerservice/managedclusters',\r\n 'microsoft.kubernetes/connectedclusters'\r\n  )\r\n| summarize ContainerResources=count() by  ResourceType=type, subscriptionId)\r\n on subscriptionId\r\n| project-away name, subscriptionId1\r\n| sort by subscriptionId",
                  "size": 1,
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "subscriptionId",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "DefenderPlan",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "subscriptionId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Standard",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "Free",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingWithBundlesBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "subscriptionId",
                                "source": "column",
                                "value": "subscriptionId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "ResourceType",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "subscriptionId",
                        "label": "Subscription"
                      }
                    ]
                  }
                },
                "conditionalVisibility": {
                  "parameterName": "DefenderPlan",
                  "comparison": "isEqualTo",
                  "value": "Containers"
                },
                "name": "query-Containers"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "securityresources\r\n| where type =~ \"microsoft.security/pricings\" \r\n| where name =~ \"KeyVaults\"\r\n| project subscriptionId, name, DefenderPlan=properties.pricingTier \r\n| join \r\n(Resources\r\n| where type in (\r\n  'microsoft.keyvault/vaults'\r\n  )\r\n| summarize KeyVaults=count() by  ResourceType=type, subscriptionId\r\n)\r\n on subscriptionId\r\n| project-away name, subscriptionId1\r\n| sort by subscriptionId\r\n",
                  "size": 1,
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "subscriptionId",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "DefenderPlan",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "subscriptionId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Standard",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "Free",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingWithBundlesBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "subscriptionId",
                                "source": "column",
                                "value": "subscriptionId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "ResourceType",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "subscriptionId",
                        "label": "Subscription"
                      }
                    ]
                  }
                },
                "conditionalVisibility": {
                  "parameterName": "DefenderPlan",
                  "comparison": "isEqualTo",
                  "value": "KeyVault"
                },
                "name": "query-keyvault"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "securityresources\r\n| where type =~ \"microsoft.security/pricings\" \r\n| where name =~ \"Arm\"\r\n| project subscriptionId, DefenderPlan=properties.pricingTier, Name=name\r\n\r\n\r\n",
                  "size": 1,
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "subscriptionId",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "DefenderPlan",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "subscriptionId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Standard",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "Free",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingWithBundlesBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "subscriptionId",
                                "source": "column",
                                "value": "subscriptionId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "Name",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "name",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "subscriptionId",
                        "label": "Subscription"
                      }
                    ]
                  }
                },
                "conditionalVisibility": {
                  "parameterName": "DefenderPlan",
                  "comparison": "isEqualTo",
                  "value": "ARM"
                },
                "name": "query-arm"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "securityresources\r\n| where type =~ \"microsoft.security/pricings\" \r\n| where name =~ \"Dns\"\r\n| project subscriptionId, DefenderPlan=properties.pricingTier, Name=name\r\n",
                  "size": 1,
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "subscriptionId",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "DefenderPlan",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "subscriptionId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Standard",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "Free",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingWithBundlesBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "subscriptionId",
                                "source": "column",
                                "value": "subscriptionId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "Name",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "name",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "subscriptionId",
                        "label": "Subscription"
                      }
                    ]
                  }
                },
                "conditionalVisibility": {
                  "parameterName": "DefenderPlan",
                  "comparison": "isEqualTo",
                  "value": "DNS"
                },
                "name": "query-dns"
              },
              {
                "type": 1,
                "content": {
                  "json": "## Log Analytics Workspaces onboarded to Defender for Cloud"
                },
                "name": "text -Workspaces",
                "styleSettings": {
                  "margin": "10px",
                  "padding": "10px"
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "resources\r\n| where type =~ 'microsoft.operationsmanagement/solutions'\r\n| where plan.product =~ 'OMSGallery/SecurityCenterFree' or plan.product =~ 'OMSGallery/Security'or plan.product =~ 'OMSGallery/SQLAdvancedThreatProtection' or plan.product =~ 'OMSGallery/SQLVulnerabilityAssessment'\r\n| project Solution=plan.name, Workspace=tolower(tostring(properties.workspaceResourceId)), subscriptionId\r\n| join kind=leftouter(\r\nresources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| project Workspace=tolower(tostring(id)),subscriptionId) on Workspace\r\n| summarize Solutions = strcat_array (make_list(Solution), ' ,') by Workspace, Subscription = subscriptionId\r\n| extend CSPM = iif(Solutions has 'SecurityCenterFree','ON','OFF')\r\n| extend Servers = iif(Solutions has 'Security','ON','OFF')\r\n| extend SQLServeronMachines = iif(Solutions has 'SQLAdvancedThreatProtection','ON','OFF')\r\n| project-away Solutions\r\n\r\n",
                  "size": 1,
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "Subscription",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "CSPM",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "Workspace",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "ON",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "OFF",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingBladeForWorkspace",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "workspaceId",
                                "source": "column",
                                "value": "Workspace"
                              },
                              {
                                "name": "",
                                "source": "column",
                                "value": ""
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "Servers",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "Workspace",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "ON",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "OFF",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingBladeForWorkspace",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "workspaceId",
                                "source": "column",
                                "value": "Workspace"
                              },
                              {
                                "name": "",
                                "source": "column",
                                "value": ""
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "SQLServeronMachines",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "Workspace",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "ON",
                              "representation": "green",
                              "text": "On"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "OFF",
                              "representation": "yellow",
                              "text": "Off"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "PolicyPricingBladeForWorkspace",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "workspaceId",
                                "source": "column",
                                "value": "Workspace"
                              },
                              {
                                "name": "",
                                "source": "column",
                                "value": ""
                              }
                            ]
                          }
                        }
                      }
                    ]
                  }
                },
                "name": "query-LAworspacesDefenderPlan"
              }
            ],
            "exportParameters": true
          },
          "conditionalVisibility": {
            "parameterName": "Tabselected",
            "comparison": "isEqualTo",
            "value": "DefenderPlansList"
          },
          "name": "group - DefenderPlans"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "items": [
              {
                "type": 1,
                "content": {
                  "json": "## Need to Fix Issues with Endpoint Solution"
                },
                "name": "text - 4"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "SecurityResources\r\n| where type == 'microsoft.security/assessments'\r\n| where properties.status.code =~ 'Unhealthy'\r\n| where (properties.displayName =~ 'Install endpoint protection solution on virtual machines') or (properties.displayName =~ 'Endpoint protection should be installed on virtual machine scale sets') or (properties.displayName =~ 'Endpoint protection health issues on machines should be resolved') or (properties.displayName =~ 'Endpoint protection should be installed on machines')\r\n| extend resourceId=id,\r\n\trecommendationId=name,\r\n\tresourceType=type,\r\n\trecommendationName=properties.displayName,\r\n\tsource=properties.resourceDetails.Source,\r\n\trecommendationState=properties.status.code,\r\n\tdescription=properties.metadata.description,\r\n\tassessmentType=properties.metadata.assessmentType,\r\n\tremediationDescription=properties.metadata.remediationDescription,\r\n\tpolicyDefinitionId=properties.metadata.policyDefinitionId,\r\n\timplementationEffort=properties.metadata.implementationEffort,\r\n\trecommendationSeverity=properties.metadata.severity,\r\n\tcategory=properties.metadata.categories,\r\n\tuserImpact=properties.metadata.userImpact,\r\n\tthreats=properties.metadata.threats,\r\n\tportalLink=properties.links.azurePortal,\r\n    Resource=properties.resourceDetails.Id\r\n| project Subscription=subscriptionId, ResourceGroup=resourceGroup, Resource, Recommendation=recommendationName, Status=recommendationState, recommendationId\r\n    ",
                  "size": 1,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "Subscription",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "ResourceGroup",
                        "formatter": 14,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "Resource",
                        "formatter": 13,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "Recommendation",
                        "formatter": 5
                      },
                      {
                        "columnMatch": "Status",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "recommendationId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Unhealthy",
                              "representation": "redBright",
                              "text": "Unhealthy"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "RecommendationsBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "assessmentKey",
                                "source": "column",
                                "value": "recommendationId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "recommendationId",
                        "formatter": 5
                      }
                    ],
                    "hierarchySettings": {
                      "treeType": 1,
                      "groupBy": [
                        "Recommendation"
                      ],
                      "finalBy": "Recommendation"
                    }
                  }
                },
                "name": "query-endpointsolution"
              },
              {
                "type": 1,
                "content": {
                  "json": "## Need to Fix Issues with Log Analytics Agent"
                },
                "name": "text - 4 - Copy"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "SecurityResources\r\n| where type == 'microsoft.security/assessments'\r\n| where properties.status.code =~ 'Unhealthy'\r\n| where (properties.displayName =~ 'Auto provisioning of the Log Analytics agent should be enabled on subscriptions') or (properties.displayName =~ 'Log Analytics agent should be installed on virtual machines') or (properties.displayName =~ 'Log Analytics agent should be installed on virtual machine scale sets') or (properties.displayName =~ 'Log Analytics agent should be installed on Linux-based Azure Arc-enabled machines') or (properties.displayName =~ 'Log Analytics agent should be installed on Windows-based Azure Arc-enabled machines')\r\n| extend resourceId=id,\r\n\trecommendationId=name,\r\n\tresourceType=type,\r\n\tRecommendation=properties.displayName,\r\n\tsource=properties.resourceDetails.Source,\r\n\tStatus=properties.status.code,\r\n\tdescription=properties.metadata.description,\r\n\tassessmentType=properties.metadata.assessmentType,\r\n\tremediationDescription=properties.metadata.remediationDescription,\r\n\tpolicyDefinitionId=properties.metadata.policyDefinitionId,\r\n\timplementationEffort=properties.metadata.implementationEffort,\r\n\trecommendationSeverity=properties.metadata.severity,\r\n\tcategory=properties.metadata.categories,\r\n\tuserImpact=properties.metadata.userImpact,\r\n\tthreats=properties.metadata.threats,\r\n\tportalLink=properties.links.azurePortal,\r\n    Resource=properties.resourceDetails.Id\r\n| project Subscription=subscriptionId, ResourceGroup=resourceGroup, Resource, Recommendation, Status, recommendationId\r\n",
                  "size": 1,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "Subscription",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "ResourceGroup",
                        "formatter": 14,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "Resource",
                        "formatter": 13,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "Recommendation",
                        "formatter": 5
                      },
                      {
                        "columnMatch": "Status",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "recommendationId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Unhealthy",
                              "representation": "redBright",
                              "text": "Unhealthy"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "RecommendationsBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "assessmentKey",
                                "source": "column",
                                "value": "recommendationId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "recommendationId",
                        "formatter": 5
                      }
                    ],
                    "hierarchySettings": {
                      "treeType": 1,
                      "groupBy": [
                        "Recommendation"
                      ],
                      "finalBy": "Recommendation"
                    }
                  }
                },
                "name": "query-LogAnalyticsAgent"
              },
              {
                "type": 1,
                "content": {
                  "json": "## Need to fix issues with Agents on Kubernetes Enviroments"
                },
                "name": "text - 7"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "SecurityResources\r\n| where type == 'microsoft.security/assessments'\r\n| where properties.status.code =~ 'Unhealthy'\r\n| where (properties.displayName =~ 'Azure Kubernetes Service clusters should have Defender profile enabled') or (properties.displayName =~ 'Azure Arc-enabled Kubernetes clusters should have the Azure Policy extension installed') or (properties.displayName =~ 'Azure Kubernetes Service clusters should have the Azure Policy add-on for Kubernetes installed') \r\n| extend resourceId=id,\r\n\trecommendationId=name,\r\n\tresourceType=type,\r\n\tRecommendation=properties.displayName,\r\n\tsource=properties.resourceDetails.Source,\r\n\tStatus=properties.status.code,\r\n\tdescription=properties.metadata.description,\r\n\tassessmentType=properties.metadata.assessmentType,\r\n\tremediationDescription=properties.metadata.remediationDescription,\r\n\tpolicyDefinitionId=properties.metadata.policyDefinitionId,\r\n\timplementationEffort=properties.metadata.implementationEffort,\r\n\trecommendationSeverity=properties.metadata.severity,\r\n\tcategory=properties.metadata.categories,\r\n\tuserImpact=properties.metadata.userImpact,\r\n\tthreats=properties.metadata.threats,\r\n\tportalLink=properties.links.azurePortal,\r\n    Resource=properties.resourceDetails.Id\r\n| project Subscription=subscriptionId, ResourceGroup=resourceGroup, Resource, Recommendation, Status, recommendationId\r\n",
                  "size": 1,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "Subscription",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "ResourceGroup",
                        "formatter": 14,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "Resource",
                        "formatter": 13,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "Recommendation",
                        "formatter": 5
                      },
                      {
                        "columnMatch": "Status",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "recommendationId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Unhealthy",
                              "representation": "redBright",
                              "text": "Unhealthy"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "RecommendationsBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "assessmentKey",
                                "source": "column",
                                "value": "recommendationId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "recommendationId",
                        "formatter": 5
                      }
                    ],
                    "hierarchySettings": {
                      "treeType": 1,
                      "groupBy": [
                        "Recommendation"
                      ],
                      "finalBy": "Recommendation"
                    }
                  }
                },
                "name": "query-ContainerAgents"
              },
              {
                "type": 1,
                "content": {
                  "json": "## Need to fix issues with Vulnerability Assessment Solution"
                },
                "name": "text - 7 - Copy"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "SecurityResources\r\n| where type == 'microsoft.security/assessments'\r\n| where properties.status.code =~ 'Unhealthy'\r\n| where (properties.displayName =~ 'Machines should have a vulnerability assessment solution') or (properties.displayName =~ 'SQL servers should have vulnerability assessment configured') \r\n| extend resourceId=id,\r\n\trecommendationId=name,\r\n\tresourceType=type,\r\n\tRecommendation=properties.displayName,\r\n\tsource=properties.resourceDetails.Source,\r\n\tStatus=properties.status.code,\r\n\tdescription=properties.metadata.description,\r\n\tassessmentType=properties.metadata.assessmentType,\r\n\tremediationDescription=properties.metadata.remediationDescription,\r\n\tpolicyDefinitionId=properties.metadata.policyDefinitionId,\r\n\timplementationEffort=properties.metadata.implementationEffort,\r\n\trecommendationSeverity=properties.metadata.severity,\r\n\tcategory=properties.metadata.categories,\r\n\tuserImpact=properties.metadata.userImpact,\r\n\tthreats=properties.metadata.threats,\r\n\tportalLink=properties.links.azurePortal, \r\n    Resource=properties.resourceDetails.Id\r\n| project Subscription=subscriptionId, ResourceGroup=resourceGroup, Resource, Recommendation, Status, recommendationId\r\n",
                  "size": 1,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "Subscription",
                        "formatter": 15,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "ResourceGroup",
                        "formatter": 14,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "Resource",
                        "formatter": 13,
                        "formatOptions": {
                          "linkTarget": null,
                          "showIcon": true
                        }
                      },
                      {
                        "columnMatch": "Recommendation",
                        "formatter": 5
                      },
                      {
                        "columnMatch": "Status",
                        "formatter": 18,
                        "formatOptions": {
                          "linkColumn": "recommendationId",
                          "linkTarget": "OpenBlade",
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Unhealthy",
                              "representation": "redBright",
                              "text": "Unhealthy"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "blue",
                              "text": "{0}{1}"
                            }
                          ],
                          "bladeOpenContext": {
                            "bladeName": "RecommendationsBlade",
                            "extensionName": "Microsoft_Azure_Security",
                            "bladeParameters": [
                              {
                                "name": "assessmentKey",
                                "source": "column",
                                "value": "recommendationId"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "recommendationId",
                        "formatter": 5
                      }
                    ],
                    "hierarchySettings": {
                      "treeType": 1,
                      "groupBy": [
                        "Recommendation"
                      ],
                      "finalBy": "Recommendation"
                    }
                  }
                },
                "name": "query-vulnerabilityAssessmentSolution"
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "Tabselected",
            "comparison": "isEqualTo",
            "value": "AgentHealth"
          },
          "name": "group-AgentHealth"
        }
      ],
      "isLocked": false,
      "fallbackResourceIds": [
        "Azure Security Center"
      ]
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2021-03-08",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "[string(variables('workbookContent'))]",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}
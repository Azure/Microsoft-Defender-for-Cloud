Remove Malware Scanning Index Tags
==============================

This PowerShell script scans Azure Storage accounts for blobs with malware scanning tags and removes them from non-malicious blobs.

Description
-----------

The script connects to an Azure subscription, scans specified or all storage accounts, identifies blobs with malware scanning tags, and removes those tags if the blobs are not malicious.

Blob Index Tags and On-Upload Scans
-----------------------------------

Blob index tags are metadata fields on a blob that categorize data in your storage account using key-value attributes. They are automatically indexed and exposed as a searchable multi-dimensional index, enabling easy data search and management.In the context of malware scanning with Microsoft Defender for Storage, the following tags are used:

*   **Malware Scanning scan time UTC**: Indicates the time when the blob was scanned.
    
*   **Malware Scanning scan result**: Stores the result of the malware scan.
    

When a blob is uploaded to Azure Storage, it is automatically scanned for malware if Microsoft Defender for Storage is enabled. The results of this scan are stored in the blob index tags, which can then be used to identify and manage blobs based on their scan results.

Prerequisites
-------------

1.  **PowerShell 7**
    
2.  **Azure PowerShell Modules:**
    
    *   Az.Accounts
        
    *   Az.Storage
        
3.  **Permissions:**
    
    *   Owner or Storage Blob Data Contributor role on the storage account.
        
4.  The script must be run in a context that has the necessary Azure permissions.
    
5.  Tags "Malware Scanning scan time UTC" and "Malware Scanning scan result" must be present on the blobs.
    
6.  **Azure CLI:** Must be authenticated using az login command if using AAD authentication.
    
7.  The script should be executed in a PowerShell environment that supports Azure modules:
    
    *   Azure Cloud Shell
        
    *   Local environment with Azure PowerShell modules installed
        
8.  **Execution Policy:** Should allow running scripts (e.g., RemoteSigned).
    

Parameters
----------

*   **SubscriptionId**: The ID of the Azure subscription to scan.
    
*   **StorageAccountName**: (Optional) The name of a specific storage account to scan.
    
*   **ResourceGroupName**: (Optional) The name of the resource group containing the specified storage account. Required if you are specifying a specific storage account.
    
*   **DaysThreshold**: (Optional) The number of days to use as the threshold for recent blobs. Default is 7 days.
    

Usage
-----

To run this script, you can use the following command to scan a specific storage account:

```powershell
.\RemoveMalwareScanningIndexTags.ps1 -SubscriptionId "your-subscription-id" -ResourceGroupName "your-resource-group" -StorageAccountName "your-storage-account-name" -DaysThreshold 7
```

To scan all storage accounts in a subscription:

```powershell 
.\RemoveMalwareScanningIndexTags.ps1 -SubscriptionId "your-subscription-id" -DaysThreshold 7   
```